+function(d){var c=function(f,e){this.$element=d(f);this.options=d.extend({},c.DEFAULTS,e);this.elements=this.$element.find(":input:not(button)");this.init()};c.VERSION="1.0.0";c.DEFAULTS={};c.prototype.init=function(){d.fn.setFormDatasTODO=function(l,h){var n=d(this);for(var j in l){var k="input[name='"+j+"'],select[name='"+j+"'],textarea[name='"+j+"']";var i=n.find(k);if(h==false){if(d.trim(i.val())!=""){continue}}var m=l[j];i.val(m);if(i.is("select")){i.select2()}}};var g=this;var e=this.$element;var f=this.options;if(f.editrulesurl&&f.editrulesurl!="false"){e.ajaxJsonUrl(Util.smartParseURL(f.editrulesurl),function(j){for(var i in j){var h=e.find("[name='"+i+"']");if(h.size()==0){continue}var m=j[i];if(h.data("tooltips")==undefined&&m.tooltips){h.attr("data-tooltips",m.tooltips);delete m.tooltips}if(h.attr("readonly")==undefined&&m.readonly){var l=e.find("input[name='id']");if(h.attr("readonly")==undefined&&l&&l.val()!=""){h.attr("readonly","true")}delete m.readonly}if(h.attr("maxlength")==undefined&&m.maxlength){h.attr("maxlength",m.maxlength)}if(h.attr("required")==undefined&&m.required){h.attr("required",true)}for(var k in m){if(h.attr("data-rule-"+k)){delete m[k]}if(!d.validator.methods[k]){Global.notify("error","未定义的表单校验规则："+k);delete m[k]}h.attr("data-rule-"+k,m[k])}}g.preProcess();g.validateProcess();g.postProcess()})}else{g.preProcess();g.validateProcess();g.postProcess()}};c.prototype.preProcess=function(){var e=this.$element;var f=this.options;if(e.attr("method")!=undefined&&e.attr("method").toUpperCase()=="POST"){if(!e.hasClass("form-track-disabled")){e.on("change",this.elements,function(){e.attr("form-data-modified","true")});e.on("keyup","textarea",function(){e.attr("form-data-modified","true")})}}if(f&&f.bindEvents){f.bindEvents.call(e,{})}e.on("click",":submit",function(g){d('table[data-grid="items"]',e).each(function(){var i=d(this);if(i.jqGrid("isEditingMode",true)){g.preventDefault();g.stopPropagation();return false}});if(f&&f.preValidate){var h=f.preValidate.call(e);if(h!=undefined&&h==false){g.preventDefault();g.stopPropagation();return false}}return true});this.elements.each(function(){var j=d(this);var h=j.data();if(j.is(":text,textarea")&&!j.hasClass("form-control")){j.addClass("form-control")}var g=j.closest(".form-group").find(".control-label:first");if(h.tooltips){var l=Util.dataStartWith("tooltips",h);var k=g.children("span.tooltipster");if(k.size()==0){k=d('<span class="glyphicon glyphicon-exclamation-sign tooltipster" title="'+j.attr("data-tooltips")+'"></span>');k.appendTo(g);if(l.position==undefined&&e.find("[data-rule-date]").length>0){l.position="right"}k.tooltipster(d.extend({contentAsHTML:true,offsetY:15,theme:"tooltipster-punk",position:"top"},l))}}if(j.attr("required")){var k=g.children("span.required");if(k.size()==0){k=d('<span class="required">*</span>');k.appendTo(g)}}if(j.attr("maxlength")){j.maxlength({limitReachedClass:"label label-danger",alwaysShow:true})}if(j.is(":text")){j.blur(function(){j.val(d.trim(j.val()))});var i=j.attr("data-spell-to");if("undefined"!=typeof Pinyin&&i){j.change(function(){var n=j.val();if(n!=""){var m=e.find('input[name="'+i+'"]');m.val(Pinyin.getCamelChars(n))}})}}})};c.prototype.validateProcess=function(){var e=this.$element;var f=this.options;this.validator=e.validate({errorElement:"span",errorClass:"error-block",focusInvalid:true,ignore:":disabled",errorPlacement:function(g,h){var i=h.closest(".form-group").find(".error-placement");if(i.size()>0){g.appendTo(i)}else{if(h.parent(".input-group").size()>0){g.insertAfter(h.parent(".input-group"))}else{if(h.parent(".input-icon").parent(".input-group").size()){g.insertAfter(h.parent(".input-icon").parent(".input-group"))}else{if(h.attr("data-error-container")){g.appendTo(d(h.attr("data-error-container")))}else{if(h.parents(".controls-radiobuttons").size()>0){g.appendTo(h.parents(".controls-radiobuttons"))}else{if(h.parents(".radio-list").size()>0){g.insertAfter(h.parents(".radio-list"))}else{if(h.parent(".radio-inline").size()>0){g.appendTo(h.parent(".radio-inline").parent())}else{if(h.parents(".controls-checkboxes").size()>0){g.appendTo(h.parents(".controls-checkboxes"))}else{if(h.parents(".checkbox-list").size()>0){g.insertAfter(h.parents(".checkbox-list"))}else{if(h.parent(".checkbox-inline").size()>0){g.appendTo(h.parent(".checkbox-inline").parent())}else{if(h.parent(".check-radio-label").size()>0){g.appendTo(h.parent(".check-radio-label").parent())}else{g.insertAfter(h)}}}}}}}}}}}},invalidHandler:function(h,g){App.scrollTo(d(g.errorList[0].element).closest(".form-group"),-100)},highlight:function(g){d(g).closest(".form-group").addClass("has-error");d(g).closest("td").addClass("has-error")},unhighlight:function(g){var h=d(g).closest(".form-group").find(".error-placement");if(h.size()>0){if(h.find(".error-block").size()>0){return}}d(g).closest("td").removeClass("has-error");d(g).closest(".form-group").removeClass("has-error");d(g).closest("form").find(".form-error-placement").empty()},success:function(g){g.remove()},submitHandler:function(i){var l=d(this.submitButton);if(l.attr("data-form-action")){e.attr("action",l.attr("data-form-action"))}if(l.attr("data-confirm")){if(!confirm(l.attr("data-confirm"))){return false}}if(f.submitHandler){f.submitHandler.call(this,i);return false}var r=e.trigger("form-validate-success");if(r!=undefined&&r==false){return}var q=e.attr("target");if(q){i.submit();return true}var p=e.attr("data-grid-search");var o=e.attr("data-div-search");if(p){var t=d(p);var g=t.data("gridOptions").url;if(g.indexOf("?")>-1){g=g+"&"+e.serialize()}else{g=g+"?"+e.serialize()}var m={datatype:"json",url:g};var n={};e.find(".grid-param-data").each(function(){var v=d(this);n[v.attr("name")]=v.val()});m.bindSearchFormData=n;if(!t.hasClass("ui-jqgrid-btable")){Grid.initGrid(t,m)}else{t.jqGrid("setGridParam",m).trigger("reloadGrid")}return}if(o){var u=e.closest(".panel-content");if(u.size()==0){u=d("body")}var j=u.find(o);if(j.is("tbody")){j.parent("table.table-infinite-scroll").removeAttr("data-scroll-loading").removeAttr("data-scroll-page")}var g=e.attr("action");if(g.indexOf("?")>-1){g=g+"&"+e.serialize()}else{g=g+"?"+e.serialize()}j.ajaxGetUrl(g,false);return false}App.blockUI({target:e,animate:true,overlayColor:"none"});var l=d(this.submitButton);l.attr("disabled",true);var h={};d('table[data-grid="items"]',e).each(function(){var v=d(this);h=d.extend(true,h,v.jqGrid("getDirtyRowdatas"))});if(l.attr("_serverValidationConfirmed_")){h._serverValidationConfirmed_=true;l.removeAttr("_serverValidationConfirmed_")}var s=l.closest(".form-actions");if(s.size()==0){s=l}e.find(".alert-validation").remove();var k=!!window.ActiveXObject;if(k){e.find("input[type='file']").attr("disabled",true)}e.ajaxSubmit({dataType:"json",method:"post",data:h,success:function(v){if(k){e.find("input[type='file']").attr("disabled",false)}l.attr("disabled",false);App.unblockUI(e);e.find("input[name='token']").val(new Date().getTime());if(v.type=="confirm"){swal({title:v.message+" 请确认是否继续提交表单？",text:v.data?v.data.join("<br/>"):v.message,allowOutsideClick:false,showConfirmButton:true,showCancelButton:true,closeOnConfirm:true,closeOnCancel:true,confirmButtonText:"确认",cancelButtonText:"取消"},function(N){if(N){l.attr("_serverValidationConfirmed_",true);l.click()}else{l.removeAttr("_serverValidationConfirmed_")}});return}if(v.type=="success"||v.type=="warning"){var C=e.triggerHandler("form-submit-success",[v]);if(C!=undefined&&C==false){return}if(v.message){if(!Global.notify(v.type,v.message)){var I=e.find("div.alert-edit-success");if(I.size()==0){I=d("<div class='alert alert-success alert-edit-success'><p>"+v.message+"</p></div>");var A=l.closest(".form-actions");if(A.size()>0){I.insertBefore(A)}else{I.prependTo(e)}}else{I.html(v.message)}if(v.redirect){var z=10;var L=d("<p>"+z+"秒后自动跳转，<a class='auto' href='javascript:;'>取消自动跳转</a>|<a class='now' href='javascript:;'>立即跳转</a></p>").appendTo(I);window.timer=setInterval(function(){z--;if(z>0){L.html(z+"秒后自动跳转，<a class='auto' href='javascript:;'>取消自动跳转</a>|<a class='now' href='javascript:;'>立即跳转</a>")}else{clearInterval(window.timer);window.location.href=Util.smartParseURL(v.redirect)}},1000);L.on("click","a.auto",function(){clearInterval(window.timer);L.html("<a class='now' href='javascript:;'>点击跳转</a>")});L.on("click","a.now",function(){clearInterval(window.timer);window.location.href=Util.smartParseURL(v.redirect)})}}}e.attr("form-data-modified","false");var D=l.attr("data-grid-reload");var K=l.attr("data-post-dismiss");if(K){var B=l.closest(".modal-dialog");if(K=="modal"&&B.size()>0){B.find(".modal-header button[data-dismiss='modal']").click()}}else{var H=l.attr("data-success-reload");if(H!="false"){var B=l.closest(".modal");if(B.size()>0){var G=l.closest(".tabbable",B);if(G.size()==0){B.modal("hide")}else{var J=G.first().find("ul.nav > li:not(.tools)");if(J.size()<=1){B.modal("hide")}else{var F=l.closest("form").find("input[name='id']").val();if(F&&F!=""){G.find(" > ul.nav > li.tools > .reload").click()}else{var E=G.closest(".ajax-get-container");var y=Util.addOrReplaceUrlParameter(E.attr("data-url"),"id",v.data.id);E.ajaxGetUrl(y)}}}}if(H=="_panel"){var x=l.closest(".panel-content");x.ajaxGetUrl(x.attr("data-url"))}}}if(D){d(D).jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")}}else{if(v.type=="failure"||v.type=="error"){e.find(".alert-success").hide();var M=e.triggerHandler("form-submit-failure",[v]);if(M==undefined||M==true){var w=e.find(".form-error-placement");if(w.size()>0){w.closest(".form-group").addClass("has-error");w.html('<span class="error-block">'+v.message+"</span>")}else{s.before("<div class='alert alert-danger alert-validation'>"+v.message+"</div>")}d("img.captcha-img",e).click()}}else{e.find(".alert-success").hide();s.before("<div class='alert alert-danger alert-validation'>E03: 表单处理异常，请联系管理员</div>");d("img.captcha-img",e).click()}}},error:function(z,y,v){l.attr("disabled",false);App.unblockUI(e);e.find(".alert-success").hide();e.find("input[name='token']").val(new Date().getTime());d("img.captcha-img",e).click();try{var x="E04: 表单处理异常，请联系管理员";var w=jQuery.parseJSON(z.responseText);if(w.type=="failure"||w.type=="error"){x=w.message;Global.notify("error",x)}}catch(y){Global.notify("error","数据处理异常")}s.before("<div class='alert alert-danger alert-validation'>"+x+"</div>")}});return false}})};c.prototype.postProcess=function(){var e=this.$element;var f=this.options;d('.form-body .row[data-equal-height!="false"]',e).each(function(){var g=0;var h=d(this).find(" > div > .form-group > div, > .form-group > div");h.each(function(){var i=10;if(d(this).is(".ui-sortable")){i=d(this).find("div:first").innerHeight()+12}else{i=d(this).innerHeight()}if(i>g){g=i}var j=d(this).prev(".control-label").innerHeight();if(j>g){g=j+2}});h.css("min-height",g)});if(e.hasClass("form-search-init")){e.submit()}if(e.hasClass("form-search-auto")){d("select",e).on("change",function(){setTimeout(function(){$form.submit()},100)});d("label.btn",e).on("click",function(){setTimeout(function(){$form.submit()},100)})}e.find('[type="reset"]').click(function(){var g=e.attr("data-grid-search");var h=e.attr("data-div-search");if(g){d(g).each(function(){d(this)[0].clearToolbar(false)})}setTimeout(function(){e.find('[data-toggle="buttons"] label.btn > input.toggle').each(function(){if(d(this).is(":checked")){d(this).parent().addClass("active")}else{d(this).parent().removeClass("active")}});e.find("input[data-date-init]").each(function(){var l=d(this);var k=l.attr("data-picker");var j=l.attr("data-date-init");if(j&&"today"==j){var i=moment().format("YYYY-MM-DD");if(k=="date-range"){l.val(i+" ~ "+i)}else{l.val(i)}}});e.find("select").each(function(){d(this).select2("val",d(this).val())});if(g||h){e.submit()}},100);return})};function b(e){return this.each(function(){var h=d(this);var g=h.data("extFormValidation");var f=typeof e=="object"&&e;if(!g){h.data("extFormValidation",(g=new c(this,f)))}if(typeof e=="string"){g[e]()}})}var a=d.fn.extFormValidation;d.fn.extFormValidation=b;d.fn.extFormValidation.Constructor=c;d.fn.extFormValidation.noConflict=function(){d.fn.extFormValidation=a;return this};Global.addComponent({name:"ExtFormValidation",plugin:b,expr:"form.form-validation",runPoint:Global.Component_Run_Point.AfterAjaxPageShow,order:50})}(jQuery);