+function(d){var c=function(f,e){this.$element=d(f);this.options=d.extend({},c.DEFAULTS,e);this.elements=this.$element.find(":input:not(button)");this.init()};c.VERSION="1.0.0";c.DEFAULTS={};c.prototype.init=function(){d.fn.setFormDatasTODO=function(l,h){var n=d(this);for(var j in l){var k="input[name='"+j+"'],select[name='"+j+"'],textarea[name='"+j+"']";var i=n.find(k);if(h==false){if(d.trim(i.val())!=""){continue}}var m=l[j];i.val(m);if(i.is("select")){i.select2()}}};var g=this;var e=this.$element;var f=this.options;if(f.editrulesurl&&f.editrulesurl!="false"){e.ajaxJsonUrl(Util.smartParseURL(f.editrulesurl),function(j){for(var i in j){var h=e.find("[name='"+i+"']");if(h.size()==0){continue}var m=j[i];if(h.data("tooltips")==undefined&&m.tooltips){h.attr("data-tooltips",m.tooltips);delete m.tooltips}if(h.attr("readonly")==undefined&&m.readonly){var l=e.find("input[name='id']");if(h.attr("readonly")==undefined&&l&&l.val()!=""){h.attr("readonly","true")}delete m.readonly}if(h.attr("maxlength")==undefined&&m.maxlength){h.attr("maxlength",m.maxlength)}if(h.attr("required")==undefined&&m.required){h.attr("required",true)}for(var k in m){if(h.attr("data-rule-"+k)){delete m[k]}if(!d.validator.methods[k]){Global.notify("error","未定义的表单校验规则："+k);delete m[k]}h.attr("data-rule-"+k,m[k])}}g.preProcess();g.validateProcess();g.postProcess()})}else{g.preProcess();g.validateProcess();g.postProcess()}};c.prototype.preProcess=function(){var e=this.$element;var f=this.options;if(e.attr("method")!=undefined&&e.attr("method").toUpperCase()=="POST"){if(!e.hasClass("form-track-disabled")){e.on("change",this.elements,function(){e.attr("form-data-modified","true")});e.on("keyup","textarea",function(){e.attr("form-data-modified","true")})}}if(f&&f.bindEvents){f.bindEvents.call(e,{})}e.on("click",":submit",function(g){d('table[data-grid="items"]',e).each(function(){var i=d(this);if(i.jqGrid("isEditingMode",true)){g.preventDefault();g.stopPropagation();return false}});if(f&&f.preValidate){var h=f.preValidate.call(e);if(h!=undefined&&h==false){g.preventDefault();g.stopPropagation();return false}}return true});this.elements.each(function(){var j=d(this);var h=j.data();if(j.is(":text,textarea")&&!j.hasClass("form-control")){j.addClass("form-control")}var g=j.closest(".form-group").find(".control-label:first");if(h.tooltips){var k=g.children("span.tooltipster");if(k.size()==0){k=d('<span data-tooltips="'+h.tooltips+'"></span>');k.appendTo(g);if(h.tooltipsPosition==undefined){if(h.ruleDate){k.attr("data-position","right")}}else{k.attr("data-position",h.tooltipsPosition)}}}if(j.attr("required")){var k=g.children("span.required");if(k.size()==0){k=d('<span class="required">*</span>');k.appendTo(g)}}if(j.attr("maxlength")){j.maxlength({limitReachedClass:"label label-danger",alwaysShow:true});j.on("maxlength.shown",function(){d("span.bootstrap-maxlength").css({zIndex:10065})})}if(j.is(":text")){j.blur(function(){j.val(d.trim(j.val()))});var i=j.attr("data-spell-to");if("undefined"!=typeof Pinyin&&i){j.change(function(){var m=j.val();if(m!=""){var l=e.find('input[name="'+i+'"]');l.val(Pinyin.getCamelChars(m))}})}}});e.find("span[data-tooltips]").each(function(){var h=d(this);var g=h.data();h.addClass("glyphicon glyphicon-exclamation-sign tooltipster");h.attr("title",g.tooltips);h.tooltipster(d.extend({contentAsHTML:true,offsetY:15,theme:"tooltipster-punk",position:"top"},g))})};c.prototype.validateProcess=function(){var e=this.$element;var g=this.options;var f=e.attr("action");if(f){e.attr("action",Util.smartParseURL(f))}this.validator=e.validate({errorElement:"span",errorClass:"error-block",focusInvalid:true,ignore:":disabled",errorPlacement:function(h,i){var j=i.closest(".form-group").find(".error-placement");if(j.size()>0){h.appendTo(j)}else{if(i.parent(".input-group").size()>0){h.insertAfter(i.parent(".input-group"))}else{if(i.parent(".input-icon").parent(".input-group").size()){h.insertAfter(i.parent(".input-icon").parent(".input-group"))}else{if(i.attr("data-error-container")){h.appendTo(d(i.attr("data-error-container")))}else{if(i.parents(".controls-radiobuttons").size()>0){h.appendTo(i.parents(".controls-radiobuttons"))}else{if(i.parents(".radio-list").size()>0){h.insertAfter(i.parents(".radio-list"))}else{if(i.parent(".radio-inline").size()>0){h.appendTo(i.parent(".radio-inline").parent())}else{if(i.parents(".controls-checkboxes").size()>0){h.appendTo(i.parents(".controls-checkboxes"))}else{if(i.parents(".checkbox-list").size()>0){h.insertAfter(i.parents(".checkbox-list"))}else{if(i.parent(".checkbox-inline").size()>0){h.appendTo(i.parent(".checkbox-inline").parent())}else{if(i.parent(".check-radio-label").size()>0){h.appendTo(i.parent(".check-radio-label").parent())}else{h.insertAfter(i)}}}}}}}}}}}},invalidHandler:function(i,h){App.scrollTo(d(h.errorList[0].element).closest(".form-group"),-100)},highlight:function(h){d(h).closest(".form-group").addClass("has-error");d(h).closest("td").addClass("has-error")},unhighlight:function(h){var i=d(h).closest(".form-group").find(".error-placement");if(i.size()>0){if(i.find(".error-block").size()>0){return}}d(h).closest("td").removeClass("has-error");d(h).closest(".form-group").removeClass("has-error");d(h).closest("form").find(".form-error-placement").empty()},success:function(h){h.remove()},submitHandler:function(j){var m=d(this.submitButton);if(m.attr("data-form-action")){e.attr("action",m.attr("data-form-action"))}if(m.attr("data-confirm")){if(!confirm(m.attr("data-confirm"))){return false}}if(g.submitHandler){g.submitHandler.call(this,j);return false}var s=e.trigger("form-validate-success");if(s!=undefined&&s==false){return}var r=e.attr("target");if(r){j.submit();return true}var q=e.attr("data-grid-search");var p=e.attr("data-div-search");if(q){var u=d(q);var h=u.data("gridOptions").url;if(h.indexOf("?")>-1){h=h+"&"+e.serialize()}else{h=h+"?"+e.serialize()}var n={datatype:"json",url:h};var o={};e.find(".grid-param-data").each(function(){var w=d(this);o[w.attr("name")]=w.val()});n.bindSearchFormData=o;if(!u.hasClass("ui-jqgrid-btable")){Grid.initGrid(u,n)}else{u.jqGrid("setGridParam",n).trigger("reloadGrid")}return}if(p){var v=e.closest(".panel-content");if(v.size()==0){v=d("body")}var k=v.find(p);if(k.is("tbody")){k.parent("table.table-infinite-scroll").removeAttr("data-scroll-loading").removeAttr("data-scroll-page")}var h=e.attr("action");if(h.indexOf("?")>-1){h=h+"&"+e.serialize()}else{h=h+"?"+e.serialize()}k.ajaxGetUrl(h,false);return false}App.blockUI({target:e,animate:true,overlayColor:"none"});var m=d(this.submitButton);m.attr("disabled",true);var i={};d('table[data-grid="items"]',e).each(function(){var w=d(this);i=d.extend(true,i,w.jqGrid("getDirtyRowdatas"))});if(m.attr("_serverValidationConfirmed_")){i._serverValidationConfirmed_=true;m.removeAttr("_serverValidationConfirmed_")}var t=m.closest(".form-actions");if(t.size()==0){t=m}e.find(".alert-validation").remove();var l=!!window.ActiveXObject;if(l){e.find("input[type='file']").attr("disabled",true)}e.ajaxSubmit({dataType:"json",method:"post",data:i,success:function(w){if(l){e.find("input[type='file']").attr("disabled",false)}m.attr("disabled",false);App.unblockUI(e);e.find("input[name='token']").val(new Date().getTime());if(w.type=="confirm"){swal({title:w.message+" 请确认是否继续提交表单？",text:w.data?w.data.join("<br/>"):w.message,allowOutsideClick:false,showConfirmButton:true,showCancelButton:true,closeOnConfirm:true,closeOnCancel:true,confirmButtonText:"确认",cancelButtonText:"取消"},function(O){if(O){m.attr("_serverValidationConfirmed_",true);m.click()}else{m.removeAttr("_serverValidationConfirmed_")}});return}if(w.type=="success"||w.type=="warning"){var D=e.triggerHandler("form-submit-success",[w]);if(D!=undefined&&D==false){return}if(w.message){if(!Global.notify(w.type,w.message)){var J=e.find("div.alert-edit-success");if(J.size()==0){J=d("<div class='alert alert-success alert-edit-success'><p>"+w.message+"</p></div>");var B=m.closest(".form-actions");if(B.size()>0){J.insertBefore(B)}else{J.prependTo(e)}}else{J.html(w.message)}if(w.redirect){var A=10;var M=d("<p>"+A+"秒后自动跳转，<a class='auto' href='javascript:;'>取消自动跳转</a>|<a class='now' href='javascript:;'>立即跳转</a></p>").appendTo(J);window.timer=setInterval(function(){A--;if(A>0){M.html(A+"秒后自动跳转，<a class='auto' href='javascript:;'>取消自动跳转</a>|<a class='now' href='javascript:;'>立即跳转</a>")}else{clearInterval(window.timer);window.location.href=Util.smartParseURL(w.redirect)}},1000);M.on("click","a.auto",function(){clearInterval(window.timer);M.html("<a class='now' href='javascript:;'>点击跳转</a>")});M.on("click","a.now",function(){clearInterval(window.timer);window.location.href=Util.smartParseURL(w.redirect)})}}}e.attr("form-data-modified","false");var E=m.attr("data-grid-reload");var L=m.attr("data-post-dismiss");if(L){var C=m.closest(".modal-dialog");if(L=="modal"&&C.size()>0){C.find(".modal-header button[data-dismiss='modal']").click()}}else{var I=m.attr("data-success-reload");if(I!="false"){var C=m.closest(".modal");if(C.size()>0){var H=m.closest(".tabbable",C);if(H.size()==0){C.modal("hide")}else{var K=H.first().find("ul.nav > li:not(.tools)");if(K.size()<=1){C.modal("hide")}else{var G=m.closest("form").find("input[name='id']").val();if(G&&G!=""){H.find(" > ul.nav > li.tools > .reload").click()}else{var F=H.closest(".ajax-get-container");var z=Util.addOrReplaceUrlParameter(F.attr("data-url"),"id",w.data.id);F.ajaxGetUrl(z)}}}}if(I=="_panel"){var y=m.closest(".panel-content");y.ajaxGetUrl(y.attr("data-url"))}}}if(E){d(E).jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")}}else{if(w.type=="failure"||w.type=="error"){e.find(".alert-success").hide();var N=e.triggerHandler("form-submit-failure",[w]);if(N==undefined||N==true){var x=e.find(".form-error-placement");if(x.size()>0){x.closest(".form-group").addClass("has-error");x.html('<span class="error-block">'+w.message+"</span>")}else{t.before("<div class='alert alert-danger alert-validation'>"+w.message+"</div>")}d("img.captcha-img",e).click()}}else{e.find(".alert-success").hide();t.before("<div class='alert alert-danger alert-validation'>E03: 表单处理异常，请联系管理员</div>");d("img.captcha-img",e).click()}}},error:function(x){m.attr("disabled",false);App.unblockUI(e);e.find(".alert-success").hide();e.find("input[name='token']").val(new Date().getTime());d("img.captcha-img",e).click();var w=Util.handleAjaxError(x);Global.notify("error",w);t.before("<div class='alert alert-danger alert-validation'>"+w+"</div>")}});return false}})};c.prototype.postProcess=function(){var e=this.$element;var f=this.options;d('.form-body .row[data-equal-height!="false"]',e).each(function(){var g=0;var h=d(this).find(" > div > .form-group > div, > .form-group > div");h.each(function(){var i=10;if(d(this).is(".ui-sortable")){i=d(this).find("div:first").innerHeight()+12}else{i=d(this).innerHeight()}if(i>g){g=i}var j=d(this).prev(".control-label").innerHeight();if(j>g){g=j+2}});h.css("min-height",g)});if(e.hasClass("form-search-init")){e.submit()}if(e.hasClass("form-search-auto")){d("select",e).on("change",function(){setTimeout(function(){$form.submit()},100)});d("label.btn",e).on("click",function(){setTimeout(function(){$form.submit()},100)})}e.find('[type="reset"]').click(function(){var g=e.attr("data-grid-search");var h=e.attr("data-div-search");if(g){d(g).each(function(){d(this)[0].clearToolbar(false)})}setTimeout(function(){e.find('[data-toggle="buttons"] label.btn > input.toggle').each(function(){if(d(this).is(":checked")){d(this).parent().addClass("active")}else{d(this).parent().removeClass("active")}});e.find("input[data-date-init]").each(function(){var l=d(this);var k=l.attr("data-picker");var j=l.attr("data-date-init");if(j&&"today"==j){var i=moment().format("YYYY-MM-DD");if(k=="date-range"){l.val(i+" ~ "+i)}else{l.val(i)}}});e.find("select").each(function(){d(this).select2("val",d(this).val())});if(g||h){e.submit()}},100);return})};function b(e){return this.each(function(){var h=d(this);var g=h.data("extFormValidation");var f=typeof e=="object"&&e;if(!g){h.data("extFormValidation",(g=new c(this,f)))}if(typeof e=="string"){g[e]()}})}var a=d.fn.extFormValidation;d.fn.extFormValidation=b;d.fn.extFormValidation.Constructor=c;d.fn.extFormValidation.noConflict=function(){d.fn.extFormValidation=a;return this};Global.addComponent({name:"ExtFormValidation",plugin:b,expr:"form.form-validation",runPoint:Global.Component_Run_Point.AfterAjaxPageShow,order:50})}(jQuery);