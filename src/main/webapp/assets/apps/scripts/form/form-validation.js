+function(d){var b=function(f,e){this.$element=d(f);this.options=d.extend({},b.DEFAULTS,e);this.elements=this.$element.find(":input:not(button)");this.init()};b.VERSION="1.0.0";b.DEFAULTS={};b.prototype.init=function(){d.fn.setFormDatasTODO=function(l,h){var n=d(this);for(var j in l){var k="input[name='"+j+"'],select[name='"+j+"'],textarea[name='"+j+"']";var i=n.find(k);if(h==false){if(d.trim(i.val())!=""){continue}}var m=l[j];i.val(m);if(i.is("select")){i.select2()}}};var g=this;var e=d(this.$element);var f=this.options;if(f.editrulesurl&&f.editrulesurl!="false"){e.ajaxJsonUrl(f.editrulesurl,function(j){for(var i in j){var h=e.find("[name='"+i+"']");if(h.size()==0){continue}var m=j[i];if(h.data("tooltips")==undefined&&m.tooltips){h.attr("data-tooltips",m.tooltips);delete m.tooltips}if(h.attr("readonly")==undefined&&m.readonly){var l=e.find("input[name='id']");if(h.attr("readonly")==undefined&&l&&l.val()!=""){h.attr("readonly","true")}delete m.readonly}if(h.attr("maxlength")==undefined&&m.maxlength){h.attr("maxlength",m.maxlength)}if(h.attr("required")==undefined&&m.required){h.attr("required",true)}for(var k in m){if(h.attr("data-rule-"+k)){delete m[k]}if(!d.validator.methods[k]){Global.notify("error","未定义的表单校验规则："+k);delete m[k]}h.attr("data-rule-"+k,m[k])}}g.preProcess();g.validateProcess();g.postProcess()})}else{g.preProcess();g.validateProcess();g.postProcess()}};b.prototype.preProcess=function(){var e=d(this.$element);var f=this.options;if(e.attr("method")!=undefined&&e.attr("method").toUpperCase()=="POST"){e.keypress(function(h){var g=h.target;if(g.tagName==="TEXTAREA"){return true}return h.which!=13});if(!e.hasClass("form-track-disabled")){e.on("change",this.elements,function(){e.attr("form-data-modified","true")});e.on("keyup","textarea",function(){e.attr("form-data-modified","true")})}}if(f&&f.bindEvents){f.bindEvents.call(e,{})}e.on("click",":submit",function(g){d('table[data-grid="items"]',e).each(function(){var i=d(this);if(i.jqGrid("isEditingMode",true)){g.preventDefault();g.stopPropagation();return false}});if(f&&f.preValidate){var h=f.preValidate.call(e);if(h!=undefined&&h==false){g.preventDefault();g.stopPropagation();return false}}return true});this.elements.each(function(){var j=d(this);if(j.is(":text,textarea")&&!j.hasClass("form-control")){j.addClass("form-control")}var h=j.closest(".form-group").find(".control-label:first");if(j.attr("data-tooltips")){var k=h.children("span.tooltipster");if(k.size()==0){k=d('<span class="glyphicon glyphicon-exclamation-sign tooltipster" title="'+j.attr("data-tooltips")+'"></span>');k.appendTo(h);var g=f.tooltipsterPosition;if(g==undefined&&e.find("[data-rule-date]").length>0){g="right"}k.tooltipster({contentAsHTML:true,offsetY:15,theme:"tooltipster-punk",position:g||"top"})}}if(j.attr("required")){var k=h.children("span.required");if(k.size()==0){k=d('<span class="required">*</span>');k.appendTo(h)}}if(j.attr("maxlength")){j.maxlength({limitReachedClass:"label label-danger",alwaysShow:true})}if(j.is(":text")){j.blur(function(){j.val(d.trim(j.val()))});var i=j.attr("data-spell-to");if("undefined"!=typeof Pinyin&&i){j.change(function(){var m=j.val();if(m!=""){var l=e.find('input[name="'+i+'"]');l.val(Pinyin.getCamelChars(m))}})}}});e.find("label.control-label[data-tooltips]").each(function(){var g=d(this)})};b.prototype.validateProcess=function(){var e=d(this.$element);var f=this.options;this.validator=e.validate({errorElement:"span",errorClass:"error-block",focusInvalid:true,ignore:":disabled",errorPlacement:function(g,h){var i=h.closest(".form-group").find(".error-placement");if(i.size()>0){g.appendTo(i)}else{if(h.parent(".input-group").size()>0){g.insertAfter(h.parent(".input-group"))}else{if(h.parent(".input-icon").parent(".input-group").size()){g.insertAfter(h.parent(".input-icon").parent(".input-group"))}else{if(h.attr("data-error-container")){g.appendTo(d(h.attr("data-error-container")))}else{if(h.parents(".controls-radiobuttons").size()>0){g.appendTo(h.parents(".controls-radiobuttons"))}else{if(h.parents(".radio-list").size()>0){g.insertAfter(h.parents(".radio-list"))}else{if(h.parent(".radio-inline").size()>0){g.appendTo(h.parent(".radio-inline").parent())}else{if(h.parents(".controls-checkboxes").size()>0){g.appendTo(h.parents(".controls-checkboxes"))}else{if(h.parents(".checkbox-list").size()>0){g.insertAfter(h.parents(".checkbox-list"))}else{if(h.parent(".checkbox-inline").size()>0){g.appendTo(h.parent(".checkbox-inline").parent())}else{if(h.parent(".check-radio-label").size()>0){g.appendTo(h.parent(".check-radio-label").parent())}else{g.insertAfter(h)}}}}}}}}}}}},invalidHandler:function(h,g){App.scrollTo(d(g.errorList[0].element).closest(".form-group"),-100)},highlight:function(g){d(g).closest(".form-group").addClass("has-error");d(g).closest("td").addClass("has-error")},unhighlight:function(g){var h=d(g).closest(".form-group").find(".error-placement");if(h.size()>0){if(h.find(".error-block").size()>0){return}}d(g).closest("td").removeClass("has-error");d(g).closest(".form-group").removeClass("has-error");d(g).closest("form").find(".form-error-placement").empty()},success:function(g){g.remove()},submitHandler:function(i){var k=d(this.submitButton);if(k.attr("data-form-action")){e.attr("action",k.attr("data-form-action"))}if(k.attr("data-confirm")){if(!confirm(k.attr("data-confirm"))){return false}}if(f.submitHandler){f.submitHandler.call(this,i);return false}var q=e.trigger("form-validate-success");if(q!=undefined&&q==false){return}var p=e.attr("target");if(p){i.submit();return true}var o=e.attr("data-grid-search");var n=e.attr("data-div-search");if(o){var s=d(o);var g=s.data("gridOptions").url;if(g.indexOf("?")>-1){g=g+"&"+e.serialize()}else{g=g+"?"+e.serialize()}var l={datatype:"json",url:g};var m={};e.find(".grid-param-data").each(function(){var u=d(this);m[u.attr("name")]=u.val()});l.bindSearchFormData=m;if(!s.hasClass("ui-jqgrid-btable")){Grid.initGrid(s,l)}else{s.jqGrid("setGridParam",l).trigger("reloadGrid")}return}if(n){var t=e.closest(".panel-content");if(t.size()==0){t=d("body")}var j=t.find(n);if(j.is("tbody")){j.parent("table.table-infinite-scroll").removeAttr("data-scroll-loading").removeAttr("data-scroll-page")}var g=e.attr("action");if(g.indexOf("?")>-1){g=g+"&"+e.serialize()}else{g=g+"?"+e.serialize()}j.ajaxGetUrl(g,false);return false}App.blockUI({target:e,animate:true,overlayColor:"none"});var k=d(this.submitButton);k.attr("disabled",true);var h={};d('table[data-grid="items"]',e).each(function(){var u=d(this);h=d.extend(true,h,u.jqGrid("getDirtyRowdatas"))});if(k.attr("_serverValidationConfirmed_")){h._serverValidationConfirmed_=true;k.removeAttr("_serverValidationConfirmed_")}var r=k.closest(".form-actions");if(r.size()==0){r=k}e.find(".alert-validation").remove();if(Global.isIELowerVersion()){e.find("input[type='file']").attr("disabled",true)}e.ajaxSubmit({dataType:"json",method:"post",data:h,success:function(y){if(Global.isIELowerVersion()){e.find("input[type='file']").attr("disabled",false)}k.attr("disabled",false);App.unblockUI(e);e.find("input[name='token']").val(new Date().getTime());if(y.type=="confirm"){bootbox.dialog({closeButton:false,message:y.data?y.data.join("<br/>"):y.message,title:y.message+" 请确认是否继续提交表单？",buttons:{danger:{label:"取消",callback:function(){k.removeAttr("_serverValidationConfirmed_")}},main:{label:"确认",className:"blue",callback:function(){k.attr("_serverValidationConfirmed_",true);k.click()}}}});return}if(y.type=="success"||y.type=="warning"){var J=e.triggerHandler("form-submit-success",[y]);if(J!=undefined&&J==false){return}if(y.message){Global.notify(y.type,y.message)}e.attr("form-data-modified","false");if(y.redirect){window.location.href=WEB_ROOT+y.redirect}else{if(typeof(AdminPage)=="undefined"){var D=e.find("div.alert-edit-success");if(D.size()==0){D=d("<div class='alert alert-success alert-edit-success'>"+y.message+"</div>");var F=k.closest(".form-actions");if(F.size()>0){D.insertBefore(F)}else{D.prependTo(e)}}else{D.html(y.message)}}}var B=k.attr("data-grid-reload");var G=k.attr("data-post-dismiss");if(G){var H=k.closest(".modal-dialog");if(G=="modal"&&H.size()>0){H.find(".modal-header button[data-dismiss='modal']").click()}}else{var v=k.attr("data-success-reload");if(v!="false"){var H=k.closest(".modal");if(H.size()>0){var I=k.closest(".tabbable",H);if(I.size()==0){H.modal("hide")}else{var u=I.first().find("ul.nav > li:not(.tools)");if(u.size()<=1){H.modal("hide")}else{var x=k.closest("form").find("input[name='id']").val();if(x&&x!=""){I.find(" > ul.nav > li.tools > .reload").click()}else{var A=I.closest(".ajax-get-container");var w=Util.AddOrReplaceUrlParameter(A.attr("data-url"),"id",y.data.id);A.ajaxGetUrl(w)}}}}if(v=="_panel"){var z=k.closest(".panel-content");z.ajaxGetUrl(z.attr("data-url"))}}}if(B){d(B).jqGrid("setGridParam",{datatype:"json"}).trigger("reloadGrid")}}else{if(y.type=="failure"||y.type=="error"){var C=e.triggerHandler("form-submit-failure",[y]);if(C==undefined||C==true){var E=e.find(".form-error-placement");if(E.size()>0){E.closest(".form-group").addClass("has-error");E.html('<span class="error-block">'+y.message+"</span>")}else{r.before("<div class='alert alert-danger alert-validation'>"+y.message+"</div>")}d("img.captcha-img",e).click()}}else{r.before("<div class='alert alert-danger alert-validation'>E03: 表单处理异常，请联系管理员</div>");d("img.captcha-img",e).click()}}},error:function(y,x,u){k.attr("disabled",false);App.unblockUI(e);e.find("input[name='token']").val(new Date().getTime());d("img.captcha-img",e).click();try{var w="E04: 表单处理异常，请联系管理员";var v=jQuery.parseJSON(y.responseText);if(v.type=="failure"||v.type=="error"){w=v.message;Global.notify("error",w)}}catch(x){Global.notify("error","数据处理异常")}r.before("<div class='alert alert-danger alert-validation'>"+w+"</div>")}});return false}})};b.prototype.postProcess=function(){var e=d(this.$element);var f=this.options;if(e.hasClass("form-search-init")){e.submit()}if(e.hasClass("form-search-auto")){d("select",e).on("change",function(){setTimeout(function(){$form.submit()},100)});d("label.btn",e).on("click",function(){setTimeout(function(){$form.submit()},100)})}e.find('[type="reset"]').click(function(){var g=e.attr("data-grid-search");var h=e.attr("data-div-search");if(g){d(g).each(function(){d(this)[0].clearToolbar(false)})}setTimeout(function(){e.find('[data-toggle="buttons"] label.btn > input.toggle').each(function(){if(d(this).is(":checked")){d(this).parent().addClass("active")}else{d(this).parent().removeClass("active")}});e.find("input[data-date-init]").each(function(){var l=d(this);var k=l.attr("data-picker");var j=l.attr("data-date-init");if(j&&"today"==j){var i=moment().format("YYYY-MM-DD");if(k=="date-range"){l.val(i+" ~ "+i)}else{l.val(i)}}});e.find("select").each(function(){d(this).select2("val",d(this).val())});if(g||h){e.submit()}},100);return})};function c(e){return this.each(function(){var h=d(this);var g=h.data("formValidation");var f=typeof e=="object"&&e;if(!g){h.data("formValidation",(g=new b(this,f)))}if(typeof e=="string"){g[e]()}})}var a=d.fn.formValidation;d.fn.formValidation=c;d.fn.formValidation.Constructor=b;d.fn.formValidation.noConflict=function(){d.fn.formValidation=a;return this};Global.addComponent({plugin:c,expr:"form",order:50})}(jQuery);